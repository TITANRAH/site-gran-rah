---
import Layout from "@/layouts/Layout.astro";
import PostCard from "@/components/blog/PostCard.astro";
import { PostsSchema, HomePageSchema } from "@/types";

export const prerender = true;

Astro.response.headers.set('Cache-Control', 'public, s-maxage=60, stale-while-revalidate=120');

const pageUrl = `${import.meta.env.API_URL}/pages?slug=blog`;
const pageResponse = await fetch(pageUrl);
const pageJson = await pageResponse.json();

const parsedPageData = HomePageSchema.parse(pageJson[0]);

const title = parsedPageData.title.rendered;

let subtitle = "";
if (
  parsedPageData.acf &&
  !Array.isArray(parsedPageData.acf) &&
  parsedPageData.acf.title
) {
  subtitle = parsedPageData.acf.title;
}

let bgImage = "";
if (
  parsedPageData.acf &&
  !Array.isArray(parsedPageData.acf) &&
  parsedPageData.acf.image &&
  typeof parsedPageData.acf.image === "object" &&
  "full" in parsedPageData.acf.image
) {
  bgImage = parsedPageData.acf.image.full.url;
}

if (
  !bgImage &&
  parsedPageData.featured_images &&
  typeof parsedPageData.featured_images === "object" &&
  "full" in parsedPageData.featured_images
) {
  bgImage = parsedPageData.featured_images.full.url;
}

const currentPage = parseInt(Astro.url.searchParams.get("page") || "1");
const perPage = 10;

const url = `${import.meta.env.API_URL}/posts?per_page=${perPage}&page=${currentPage}`;
console.log("Fetching posts from:", url);

const response = await fetch(url);

const totalPosts = parseInt(response.headers.get("X-WP-Total") || "0");
const totalPages = parseInt(response.headers.get("X-WP-TotalPages") || "1");

const json = await response.json();
const posts = PostsSchema.parse(json);
---

<Layout title={title} subtitle={subtitle} bgImage={bgImage}>
  <div class="container mx-auto px-4 py-8">
    <div class="space-y-8">
      {posts.map((post) => <PostCard post={post} />)}
    </div>

    {
      posts.length === 0 && (
        <p class="text-center text-gray-400 text-lg">
          No hay posts disponibles en esta página.
        </p>
      )
    }

    {
      totalPages > 1 && (
        <nav class="flex justify-center gap-4 mt-12 items-center flex-wrap">
          {currentPage > 1 ? (
            <a
              href={
                currentPage === 2 ? "/blog" : `/blog?page=${currentPage - 1}`
              }
              class="btn-gold px-6 py-3"
            >
              ← Anterior
            </a>
          ) : (
            <span class="px-6 py-3 text-gray-500 cursor-not-allowed">
              ← Anterior
            </span>
          )}

          <div class="flex gap-2">
            {(() => {
              const maxVisiblePages = Math.min(totalPages, 7);
              const pages = [];

              for (let i = 0; i < maxVisiblePages; i++) {
                let pageNum;

                if (totalPages < 8) {
                  pageNum = i + 1;
                } else if (currentPage < 5) {
                  pageNum = i + 1;
                } else if (currentPage > totalPages - 4) {
                  pageNum = totalPages - 6 + i;
                } else {
                  pageNum = currentPage - 3 + i;
                }

                const isCurrentPage = pageNum === currentPage;
                const href = pageNum === 1 ? "/blog" : `/blog?page=${pageNum}`;

                pages.push(
                  <a
                    href={href}
                    class={`px-4 py-2 rounded transition-colors ${
                      isCurrentPage
                        ? "bg-accent-gold text-black font-bold"
                        : "bg-secondary-bg text-white hover:bg-accent-gold hover:text-black"
                    }`}
                  >
                    {pageNum}
                  </a>
                );
              }

              return pages;
            })()}
          </div>

          {currentPage < totalPages ? (
            <a
              href={`/blog?page=${currentPage + 1}`}
              class="btn-gold px-6 py-3"
            >
              Siguiente →
            </a>
          ) : (
            <span class="px-6 py-3 text-gray-500 cursor-not-allowed">
              Siguiente →
            </span>
          )}
        </nav>
      )
    }

    <p class="text-center text-gray-400 mt-6">
      Mostrando {posts.length} de {totalPosts} posts totales
    </p>
  </div>
</Layout>
