---
import Title from "../ui/Title.astro";

interface Props {
  title?: string;
}

const { title = "Contacto" } = Astro.props;
---

<section id="contacto" class="py-16 px-4 pt-32 bg-black">
  <div class="container mx-auto max-w-4xl">
    <Title title={title} />

    <div
      class="bg-secondary-bg rounded-2xl shadow-2xl p-8 md:p-12 border-2 border-accent-gold/30"
      data-aos="fade-up"
    >
      <p class="text-gray-400 text-center text-lg mb-8">
        Llena todos los campos para enviar un mensaje. Te responderé lo antes
        posible.
      </p>

      <form method="post" class="space-y-6" novalidate>
        <div class="flex flex-col space-y-2">
          <label
            for="name"
            class="text-accent-gold font-bold uppercase text-sm tracking-wide"
          >
            Nombre <span class="text-red-500">*</span>
          </label>
          <input
            id="name"
            type="text"
            name="name"
            placeholder="Tu Nombre Completo"
            class="bg-primary-bg border-2 border-border-dark text-white px-4 py-3 rounded-lg focus:outline-none focus:border-accent-gold transition-all duration-300 placeholder:text-gray-600"
            required
          />
        </div>

        <div class="flex flex-col space-y-2">
          <label
            for="phone"
            class="text-accent-gold font-bold uppercase text-sm tracking-wide"
          >
            Teléfono
          </label>
          <input
            id="phone"
            type="tel"
            name="phone"
            placeholder="Tu Número de Teléfono (opcional)"
            class="bg-primary-bg border-2 border-border-dark text-white px-4 py-3 rounded-lg focus:outline-none focus:border-accent-gold transition-all duration-300 placeholder:text-gray-600"
          />
        </div>

        <div class="flex flex-col space-y-2">
          <label
            for="email"
            class="text-accent-gold font-bold uppercase text-sm tracking-wide"
          >
            Correo Electrónico <span class="text-red-500">*</span>
          </label>
          <input
            id="email"
            type="email"
            name="email"
            placeholder="tu@email.com"
            class="bg-primary-bg border-2 border-border-dark text-white px-4 py-3 rounded-lg focus:outline-none focus:border-accent-gold transition-all duration-300 placeholder:text-gray-600"
            required
          />
        </div>

        <div class="flex flex-col space-y-2">
          <label
            for="subject"
            class="text-accent-gold font-bold uppercase text-sm tracking-wide"
          >
            Asunto <span class="text-red-500">*</span>
          </label>
          <input
            id="subject"
            type="text"
            name="subject"
            placeholder="Asunto del Mensaje"
            class="bg-primary-bg border-2 border-border-dark text-white px-4 py-3 rounded-lg focus:outline-none focus:border-accent-gold transition-all duration-300 placeholder:text-gray-600"
            required
          />
        </div>

        <div class="flex flex-col space-y-2">
          <label
            for="message"
            class="text-accent-gold font-bold uppercase text-sm tracking-wide"
          >
            Mensaje <span class="text-red-500">*</span>
          </label>
          <textarea
            id="message"
            name="message"
            placeholder="Escribe tu mensaje aquí..."
            rows="6"
            class="bg-primary-bg border-2 border-border-dark text-white px-4 py-3 rounded-lg focus:outline-none focus:border-accent-gold transition-all duration-300 placeholder:text-gray-600 resize-none"
            required></textarea>
        </div>

        <div class="pt-4">
          <button
            id="submit-btn"
            type="submit"
            class="w-full bg-accent-gold text-black py-4 px-8 rounded-lg font-black uppercase text-lg tracking-wide hover:bg-accent-gold-hover hover:scale-[1.02] transition-all duration-300 shadow-lg hover:shadow-xl hover:shadow-accent-gold/50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
          >
            <span id="btn-text">Enviar Mensaje</span>
            <span id="btn-loader" class="hidden">
              <svg
                class="inline-block animate-spin h-5 w-5 mr-2"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              Enviando...
            </span>
          </button>
        </div>
      </form>

      <div
        class="mt-8 h-1 bg-gradient-to-r from-transparent via-accent-gold to-transparent"
      >
      </div>
    </div>
  </div>
</section>

<script>
  import { actions, isInputError } from "astro:actions";
  import { Notyf } from "notyf";
  import "notyf/notyf.min.css";

  function initContactForm() {
    const form = document.querySelector("#contacto form");
    const submitBtn = document.querySelector(
      "#submit-btn"
    ) as HTMLButtonElement;
    const btnText = document.querySelector("#btn-text") as HTMLSpanElement;
    const btnLoader = document.querySelector("#btn-loader") as HTMLSpanElement;

    if (!form || !submitBtn || !btnText || !btnLoader) {
      console.error("No se encontraron elementos del formulario");
      return;
    }

    const setLoading = (loading: boolean) => {
      if (loading) {
        submitBtn.disabled = true;
        btnText.classList.add("hidden");
        btnLoader.classList.remove("hidden");
      } else {
        submitBtn.disabled = false;
        btnText.classList.remove("hidden");
        btnLoader.classList.add("hidden");
      }
    };

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const formElement = e.target as HTMLFormElement;
      const formData = new FormData(formElement);

      const notyf = new Notyf({
        position: {
          x: "right",
          y: "top",
        },
        duration: 4000,
        ripple: false,
        dismissible: true,
      });

      setLoading(true);

      try {
        const { data, error } = await actions.contact.sendEmail(formData);

        const inputErrors = isInputError(error) ? error.issues : [];

        if (inputErrors && inputErrors.length > 0) {
          inputErrors.forEach((error) => {
            notyf.error(error.message);
          });
          return;
        }

        if (data?.status === "mail_sent") {
          notyf.success(
            "¡Mensaje enviado correctamente! Te responderé pronto."
          );
          formElement.reset();
        } else if (
          data?.status === "mail_failed" ||
          data?.status === "validation_failed"
        ) {
          const errorMsg =
            data?.message || "Error al enviar el mensaje. Inténtalo de nuevo.";
          notyf.error(errorMsg);
        } else {
          notyf.error("Error al enviar el mensaje. Inténtalo de nuevo.");
        }
      } catch (err) {
        notyf.error("Error al enviar el mensaje. Inténtalo de nuevo.");
        console.error("Error en el formulario:", err);
      } finally {
        setLoading(false);
      }
    });
  }

  initContactForm();

  document.addEventListener("astro:page-load", initContactForm);
</script>
